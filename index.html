<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>

  <body>
    <h3>Actions With NFC</h3>

    <button id="scanButton">Scan</button>
    <button id="writeButton">Write</button>
    <button id="makeReadOnlyButton">Make Read-Only</button>

    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>

    <script>
      var firebaseConfig = {
        apiKey: "AIzaSyAkQXsSCrt3uzoUjX_FMokg_ZL3bE4CoYA",
        authDomain: "olevels-live.firebaseapp.com",
        projectId: "olevels-live",
        storageBucket: "olevels-live.appspot.com",
        messagingSenderId: "39474177871",
        appId: "1:39474177871:web:8f220c929ec61638f8073a",
        measurementId: "G-6TJF0S5X3X",
      };

      firebase.initializeApp(firebaseConfig);

      var ChromeSamples = {
        log: function () {
          var line = Array.prototype.slice
            .call(arguments)
            .map(function (argument) {
              return typeof argument === "string"
                ? argument
                : JSON.stringify(argument);
            })
            .join(" ");

          document.querySelector("#log").textContent += line + "\n";
        },

        setStatus: function (status) {
          document.querySelector("#status").textContent = status;
        },

        setContent: function (newContent) {
          var content = document.querySelector("#content");
          while (content.hasChildNodes()) {
            content.removeChild(content.lastChild);
          }
          content.appendChild(newContent);
        },
      };
    </script>

    <h3>Live Output</h3>
    <div id="output" class="output">
      <div id="content"></div>
      <div id="status"></div>
      <pre id="log"></pre>
    </div>

    <script>
      log = ChromeSamples.log;

      if (!("NDEFReader" in window))
        ChromeSamples.setStatus(
          "Web NFC is not available. Use Chrome on Android."
        );

      scanButton.addEventListener("click", async () => {
        log("User clicked scan button");

        try {
          const ndef = new NDEFReader();
          await ndef.scan();
          log("> Scan started");

          ndef.addEventListener("readingerror", () => {
            log("Argh! Cannot read data from the NFC tag. Try another one?");
          });

          ndef.addEventListener("reading", ({ message, serialNumber }) => {
            log(`> Serial Number: ${serialNumber}`);
            log(`> Records: (${message.records.length})`);
          });
        } catch (error) {
          log("Argh! " + error);
        }
      });

      writeButton.addEventListener("click", async () => {
        try {
          const database = firebase.database();
          const studentsRef = database.ref("students");
          const studentName = prompt("Enter student name:");

          if (studentName) {
            studentsRef
              .child(studentName)
              .once("value")
              .then(async (snapshot) => {
                if (snapshot.exists()) {
                  log(
                    `Student with name '${studentName}' found in the database.`
                  );

                  // Retrieve existing data
                  const existingData = snapshot.val();

                  // Check if uniqueNumber and serialNumber already exist
                  if (
                    !existingData.uniqueNumber &&
                    !existingData.serialNumber
                  ) {
                    // Generate new unique number and NFC serial number
                    const uniqueNumber =
                      Date.now() + Math.floor(Math.random() * 1000);
                    const nfcSerialNumber = await getNFCSerialNumber();
                    log(nfcSerialNumber);

                    // Update existing data with new information
                    studentsRef.child(studentName).update({
                      uniqueNumber: uniqueNumber,
                      serialNumber: nfcSerialNumber,
                    });
                    const ndef = new NDEFReader();

                    try {
  await ndef.write(`Unique Number: ${uniqueNumber}, Student Name: ${studentName}`);
  log("Message written successfully.");
  log(`Data updated for student: ${studentName}, Unique Number: ${uniqueNumber}`);
} catch (error) {
  log(`Write failed: ${error}`);
}
                  } else {
                    log(
                      `Student with name '${studentName}' already has uniqueNumber and serialNumber.`
                    );
                  }
                } else {
                  log(`Student with name '${studentName}' not found.`);
                }
              })
              .catch((error) => {
                log("Error checking student name:", error.message);
              });
          } else {
            log("User did not provide a name.");
          }
        } catch (error) {
          log("Argh! " + error);
        }
      });

      async function writeNFCData(data) {
        try {
          const ndef = new NDEFWriter();
          const records = [NDEFRecord.text(data)];

          await ndef.write({ records });

          log(`NFC data written: ${data}`);
        } catch (error) {
          log("Argh! " + error);
        }
      }

      async function getNFCSerialNumber() {
        return new Promise((resolve, reject) => {
          const ndef = new NDEFReader();
          ndef.scan();
          ndef.addEventListener("reading", ({ message, serialNumber }) => {
            log(`> Serial Number: ${serialNumber}`);
            log(`> Records: (${message.records.length})`);
            resolve(serialNumber);
          });
          setTimeout(() => {
            reject(new Error("Timeout: NFC reading took too long."));
          }, 50000);
        });
      }

      makeReadOnlyButton.addEventListener("click", async () => {
        log("User clicked make read-only button");

        try {
          const ndef = new NDEFReader();
          await ndef.makeReadOnly();
          log("> NFC tag has been made permanently read-only");
        } catch (error) {
          log("Argh! " + error);
        }
      });
    </script>
  </body>
</html>
